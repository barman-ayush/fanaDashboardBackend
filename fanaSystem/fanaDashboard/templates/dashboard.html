<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Calls Dashboard</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'dashboard.css' %}">
</head>
<body>
    <div class="sidebar" id="sidebar">
        <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>

        <div id="sidebar-content" class="sidebar-content">
            <h2>My Profile</h2>
            <p>Username: {{ username }}</p>
            <p>Grp No: <span id="grp-no">XYZ</span></p>
            <button onclick="handleLogout()" class="logout-button">Logout</button>
        </div>
    </div>

    <div class="main-content" id="main-content">
        <h1>Smart Calls Dashboard</h1>
        
        <!-- Filter Dropdown -->
        <!-- <label for="filterSelect">Filter: </label>
        <select id="filterSelect" onchange="filterContent()">
            <option value="all">All</option>
            <option value="table_state">Table State</option>
            <option value="order_update">Order Updates</option>
        </select> -->
        
        <h2>Table State</h2>
        <div id="tableList" class="entry-list"></div>

        <h2>Orders</h2>
        <div id="orderList" class="entry-list"></div>
    </div>

    <script>
        // Toggle sidebar
        function toggleSidebar() {
            const sidebarContent = document.getElementById("sidebar-content");
            const sidebar = document.getElementById("sidebar");
            const mainContent = document.getElementById("main-content");
            sidebar.classList.toggle("minimized");
            sidebarContent.classList.toggle("minimized");
            mainContent.classList.toggle("expanded");
        }

        // Logout function
        function handleLogout() {
            sessionStorage.removeItem('jwt_token');
            window.location.href = "{% url 'login_view' %}";
        }

        // WebSocket connection for receiving messages
        const socket = new WebSocket('ws://' + window.location.host + '/ws/dashboard/');
        const tableList = document.getElementById("tableList");
        const orderList = document.getElementById("orderList");
        const tableMap = {};
        const orderMap = {};

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const messageType = data.message_type;

            if (messageType === "table_state") {
                // Handle table state updates
                const tableId = data.table_id;
                const state = data.state;
                const timeTaken = data.time_taken;
                const currentTime = new Date().toLocaleString();

                if (state === "calling") {
                    if (!tableMap[tableId]) {
                        const tableEntry = document.createElement("div");
                        tableEntry.className = "dashboard-event-entry";  // Apply card style
                        tableEntry.id = `table-${tableId}`;
                        tableEntry.setAttribute("data-type", "table_state");
                        tableEntry.innerHTML = `
                            <strong>Table ID:</strong> ${tableId}<br>
                            <span class="time"><strong>Time Received:</strong> ${currentTime}</span><br>
                            <span class="time"><strong>Time Taken:</strong> ${timeTaken} ms</span>
                        `;
                        tableMap[tableId] = tableEntry;
                        tableList.prepend(tableEntry);
                    } else {
                        const existingEntry = tableMap[tableId];
                        existingEntry.querySelector(".time").innerHTML = `<strong>Time Received:</strong> ${currentTime}`;
                    }
                } else if (state === "not calling" && tableMap[tableId]) {
                    const tableEntry = tableMap[tableId];
                    tableList.removeChild(tableEntry);
                    delete tableMap[tableId];
                }
            } else if (messageType === "order_update") {
                // Handle order updates
                const orderId = data.order_id;
                const orderDetails = data.order_details;

                if (!orderMap[orderId]) {
                    const orderEntry = document.createElement("div");
                    orderEntry.className = "dashboard-event-entry";  // Apply card style
                    orderEntry.id = `order-${orderId}`;
                    orderEntry.setAttribute("data-type", "order_update");
                    orderEntry.innerHTML = `
                        <strong>Order ID:</strong> ${orderId}<br>
                        <strong>Details:</strong> ${orderDetails}<br>
                        <button onclick="deleteOrder('${orderId}')">Done</button>
                    `;
                    orderMap[orderId] = orderEntry;
                    orderList.prepend(orderEntry);
                }
            }
        };

        // Handle WebSocket errors
        socket.onerror = function(error) {
            console.error("WebSocket error:", error);
        };

        socket.onclose = function() {
            console.log("WebSocket connection closed");
        };

        // Function to delete an order entry
        function deleteOrder(orderId) {
            const orderEntry = document.getElementById(`order-${orderId}`);
            if (orderEntry) {
                orderList.removeChild(orderEntry);
                delete orderMap[orderId];
            }
        }

        // Function to filter content based on dropdown selection
        function filterContent() {
            const filterValue = document.getElementById("filterSelect").value;
            const entries = document.querySelectorAll(".entry");

            entries.forEach(entry => {
                if (filterValue === "all") {
                    entry.style.display = "block"; // Show all entries
                } else if (entry.getAttribute("data-type") === filterValue) {
                    entry.style.display = "block"; // Show matching entries
                } else {
                    entry.style.display = "none";  // Hide non-matching entries
                }
            });
        }
    </script>
</body>
</html>
